---
title: "Plankton programs in the GOOS BioEco portal"
editor_options: 
  chunk_output_type: console
---

## Visualize all plankton programs

Read all phytoplankton and zooplankton programs and visualize on a map:

```{r, message=FALSE, warning=FALSE, out.width="100%", fig.width=12, fig.height=7, cache=TRUE}
library(sf)
library(dplyr)
library(glue)
library(ggplot2)
library(rnaturalearth)
library(rnaturalearthdata)

sf_use_s2(FALSE)

keywords <- c(35, 36)
keywords_encoded <- URLencode(paste0(keywords, collapse = "\\,"), reserved = TRUE)
url <- glue("https://geonode.goosocean.org/geoserver/geonode/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=geonode%3Aall_layers&maxFeatures=10000&outputFormat=application%2Fjson&viewparams=where:where%20(array%5B{keywords_encoded}%5D%20%26%26%20keywords)")

world <- ne_countries(scale = "medium", returnclass = "sf")

bbox <- st_as_sfc("POLYGON((-180 -90, -180 90, 179.9 90, 179.9 -90, -180 -90))", crs = 4326)

programs <- st_read(url, quiet = TRUE) %>%
  st_make_valid() %>%
  st_crop(bbox) %>%
  st_segmentize(dfMaxLength = 10000) %>%
  st_wrap_dateline(options = c("WRAPDATELINE=YES", "DATELINEOFFSET=230"))

ggplot() +
  geom_sf(data = world, fill = "#dddddd", color = "#888888", lwd = 0.1) +
  geom_sf(data = programs, color = "#16dbcb", fill = rgb(0.086, 0.8588, 0.796, 0.1), size = 0.5, linewidth = 0.25) +
  theme(
    panel.grid.major.x = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.x = element_blank(),
    panel.grid.minor.y = element_blank(), 
    panel.background = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    legend.position = "bottom",
    legend.key.width = unit(2, "cm")
  ) +
  xlab("") + ylab("") +
  coord_sf(crs = "+proj=robin +lon_0=0 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs" )
```

```{r, message=FALSE, warning=FALSE, out.width="100%", fig.width=12, fig.height=7, cache=TRUE}
ggplot() +
  geom_sf(data = world, fill = "#dddddd", color = "#888888", lwd = 0.1) +
  geom_sf(data = programs, color = "#16dbcb", fill = rgb(0.086, 0.8588, 0.796, 0.1), size = 0.5, linewidth = 0.25) +
  theme(
    panel.grid.major.x = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.x = element_blank(),
    panel.grid.minor.y = element_blank(), 
    panel.background = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    legend.position = "bottom",
    legend.key.width = unit(2, "cm")
  ) +
  xlab("") + ylab("") +
  coord_sf(crs = "+proj=robin +lon_0=0 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs", xlim = c(-10700000, 2000000), ylim = c(1100000, 7500000))
```

## Programs by G7 EEZ

```{r, message=FALSE, warning=FALSE, cache=TRUE}
library(dplyr)
library(arrow)
library(h3jsr)
library(tibble)

h3_res <- 7

g7_eez_names <- c("Canadian Exclusive Economic Zone", "French Exclusive Economic Zone", "French Guiana Exclusive Economic Zone", "French Polynesian Exclusive Economic Zone", "German Exclusive Economic Zone", "Italian Exclusive Economic Zone", "Japanese Exclusive Economic Zone", "United Kingdom Exclusive Economic Zone", "United States Exclusive Economic Zone", "United States Exclusive Economic Zone (Alaska)", "United States Exclusive Economic Zone (Hawaii)")

programs_buffered <- programs %>%
  st_buffer(0.1) %>%
  group_by(name) %>%
  summarize()

program_cells_list <- purrr::map(programs_buffered$geometry, function(geom) {
  polygon_to_cells(st_sfc(geom, crs = 4326), h3_res)
})
names(program_cells_list) <- programs_buffered$name





# test <- purrr::imap(mylist, function(x, name) {
#   data.frame(name = name, h3 = x)
# })
# 
# program_cells <- polygon_to_cells(programs_buffered, h3_res)
# 
# eez_cells_g7 <- open_dataset("eez_h3/eez_h3_res7.parquet") %>%
#   filter(GEONAME %in% g7_eez_names) %>%
#   select(h3 = h3_index, eez = GEONAME) %>%
#   as.data.frame()
# 
# 
# sites_h3 <- sites %>%
#   st_drop_geometry() %>%
#   select(name_simplified) %>%
#   mutate(h3 = polys) %>%
#   tidyr::unnest(h3)

```
